<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Campus Pulse</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-compass"></i>
                <div>
                    <h2>Campus Pulse</h2>
                    <p>Your guide to campus spaces</p>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item" onclick="navigate('dashboard.html'); return false;">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="campus-map.html" class="nav-item" onclick="navigate('campus-map.html'); return false;">
                    <i class="fas fa-map"></i> Campus Map
                </a>
                <a href="settings.html" class="nav-item active" onclick="navigate('settings.html'); return false;">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <div>
                    <h1>Settings</h1>
                    <p class="header-subtitle">Manage your account and data preferences.</p>
                </div>
                <div class="header-right">
                    <div class="profile-dropdown">
                        <button class="profile-btn">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div class="dropdown-menu">
                            <div class="dropdown-header">
                                <p class="user-name">Alex Doe</p>
                                <p class="user-email">alex.doe@university.edu</p>
                            </div>
                            <a href="settings.html" class="dropdown-item profile-link">
                                <span>Profile</span>
                            </a>
                            <a href="settings.html" class="dropdown-item">
                                <span>Settings</span>
                            </a>
                            <a href="javascript:void(0);" onclick="logout();" class="dropdown-item logout-link">
                                <span>Log out</span>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Settings Content -->
            <div class="settings-container">
                <!-- Profile Settings -->
                <section class="settings-section">
                    <h2 class="section-title">Profile</h2>
                    <div class="settings-card">
                        <div class="profile-section">
                            <div class="profile-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="profile-info">
                                <h3 id="profileDisplayName">Your Name</h3>
                                <p id="profileDisplayEmail">you@example.com</p>
                                <button class="btn-secondary" id="changePhotoBtn">Change Photo</button>
                            </div>
                        </div>
                        <hr class="divider">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="profileName" value="">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profileEmail" value="">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="profilePhone" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="saveProfileBtn">Save Changes</button>
                            <button class="btn-secondary" id="cancelProfileBtn">Cancel</button>
                        </div>
                    </div>
                </section>

                <!-- Privacy & Data Settings -->
                <section class="settings-section">
                    <h2 class="section-title">Privacy & Data</h2>
                    <div class="settings-card">
                        <p class="section-description">Control how your location data is used to improve Campus Pulse.</p>
                        
                        <div class="toggle-item">
                            <div class="toggle-label">
                                <h4>Contribute to Occupancy Data</h4>
                                <p>Allow Campus Pulse to use your anonymous location to provide real time occupancy data. Your exact location is never stored or shared.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <hr class="divider">

                        <div class="toggle-item">
                            <div class="toggle-label">
                                <h4>Location History</h4>
                                <p>Help us improve space recommendations by learning about your visit patterns.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <hr class="divider">

                        <div class="toggle-item">
                            <div class="toggle-label">
                                <h4>Push Notifications</h4>
                                <p>Receive notifications about occupancy changes in your favorite spaces.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        
                    </div>
                </section>

                <!-- Preferences -->
                <section class="settings-section">
                    <h2 class="section-title">Preferences</h2>
                    <div class="settings-card">
                        <!-- Theme preference removed -->

                        <!-- Language preference removed -->

                        <div class="form-group">
                            <label>Favorite Spaces (Select multiple)</label>
                            <div class="checkbox-group" id="favSpacesList">
                                <label class="checkbox-item"><input class="fav-space" type="checkbox" value="Main Library"><span>Main Library</span></label>
                                <label class="checkbox-item"><input class="fav-space" type="checkbox" value="Student Hub"><span>Student Hub</span></label>
                                <label class="checkbox-item"><input class="fav-space" type="checkbox" value="The Daily Grind Cafe"><span>The Daily Grind Cafe</span></label>
                                <label class="checkbox-item"><input class="fav-space" type="checkbox" value="Innovation Hall"><span>Innovation Hall</span></label>
                                <label class="checkbox-item"><input class="fav-space" type="checkbox" value="Central Quad"><span>Central Quad</span></label>
                                <label class="checkbox-item"><input class="fav-space" type="checkbox" value="Recreation Center"><span>Recreation Center</span></label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button class="btn-primary" id="savePrefsBtn">Save Preferences</button>
                            <button class="btn-secondary" id="cancelPrefsBtn">Cancel</button>
                        </div>
                    </div>
                </section>

                <!-- Account & Security -->
                <section class="settings-section">
                    <h2 class="section-title">Account & Security</h2>
                    <div class="settings-card">
                                <div class="settings-card">
                                    <div class="setting-row">
                                        <div>
                                            <h4>Password</h4>
                                            <p>Change your password to keep your account secure.</p>
                                        </div>
                                    </div>

                                    <hr class="divider">

                                    <form id="changePasswordForm">
                                        <div class="form-group">
                                            <label>Current password</label>
                                            <input type="password" id="currentPassword" required>
                                        </div>

                                        <div class="form-group">
                                            <label>New password</label>
                                            <input type="password" id="newPassword" required minlength="8">
                                        </div>

                                        <div class="form-group">
                                            <label>Confirm new password</label>
                                            <input type="password" id="confirmNewPassword" required minlength="8">
                                        </div>

                                        <div class="form-actions">
                                            <button class="btn-primary" id="savePasswordBtn">Change Password</button>
                                            <button class="btn-secondary" id="cancelPasswordBtn">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        function getAuthToken() { return localStorage.getItem('auth_token'); }

        async function loadProfile() {
            const token = getAuthToken();
            if (!token) return;
            try {
                console.log('Loading profile with token', token && token.slice ? token.slice(0,8) + '...' : token);
                const res = await fetch(`${API_BASE}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    console.error('Failed to load profile', res.status);
                    return;
                }
                const user = await res.json();
                document.getElementById('profileDisplayName').textContent = user.name || '';
                document.getElementById('profileDisplayEmail').textContent = user.email || '';
                document.getElementById('profileName').value = user.name || '';
                document.getElementById('profileEmail').value = user.email || '';
                document.getElementById('profilePhone').value = user.phone || '';
                // Update dropdown info if present
                const nameEl = document.querySelector('.user-name');
                const emailEl = document.querySelector('.user-email');
                if (nameEl) nameEl.textContent = user.name || '';
                if (emailEl) emailEl.textContent = user.email || '';
                // If server returned preferences, persist locally and apply
                if (user.preferences) {
                    try { localStorage.setItem(PREFS_KEY, JSON.stringify(user.preferences)); loadPreferences(); applyPreferences(); } catch(e){}
                }
            } catch (err) {
                console.error('Error loading profile', err);
            }
        }

        document.getElementById('saveProfileBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const token = getAuthToken();
            if (!token) { alert('You must be logged in'); return; }
            const name = document.getElementById('profileName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            try {
                console.log('Saving profile', { name, email, phone });
                const res = await fetch(`${API_BASE}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, email, phone })
                });
                const data = await res.json();
                console.log('Profile save response', res.status, data);
                if (res.ok) {
                    alert('Profile updated');
                    // If the API returned the updated user, update the UI immediately
                    if (data && data.user) {
                        const user = data.user;
                        document.getElementById('profileDisplayName').textContent = user.name || '';
                        document.getElementById('profileDisplayEmail').textContent = user.email || '';
                        document.getElementById('profileName').value = user.name || '';
                        document.getElementById('profileEmail').value = user.email || '';
                        document.getElementById('profilePhone').value = user.phone || '';
                        const nameEl = document.querySelector('.user-name');
                        const emailEl = document.querySelector('.user-email');
                        if (nameEl) nameEl.textContent = user.name || '';
                        if (emailEl) emailEl.textContent = user.email || '';
                        // Persist display name & email locally so other pages can read it
                        try { localStorage.setItem('user_name', user.name || ''); localStorage.setItem('user_email', user.email || ''); } catch(e){}
                    } else {
                        // Fallback: re-fetch the profile from server
                        loadProfile();
                    }
                } else {
                    alert(data.message || 'Failed to update profile');
                }
            } catch (err) {
                console.error('Error updating profile', err);
                alert('Server error');
            }
        });

        document.getElementById('cancelProfileBtn').addEventListener('click', (e) => {
            e.preventDefault();
            loadProfile();
        });

        // Load profile on page load
        window.addEventListener('load', () => { loadProfile(); loadPreferences(); applyPreferences(); });

        // Preferences persistence
        const PREFS_KEY = 'user_prefs';

        function defaultPreferences() {
            return {
                favorites: [],
                contribute: true,
                history: false,
                push: true
            };
        }

        function loadPreferences() {
            try {
                const raw = localStorage.getItem(PREFS_KEY);
                const prefs = raw ? JSON.parse(raw) : defaultPreferences();
                // toggles (find checkboxes by position)
                const toggles = document.querySelectorAll('.switch input[type="checkbox"]');
                if (toggles && toggles.length >= 3) {
                    toggles[0].checked = !!prefs.contribute;
                    toggles[1].checked = !!prefs.history;
                    toggles[2].checked = !!prefs.push;
                }
                // favorites
                const favs = prefs.favorites || [];
                document.querySelectorAll('.fav-space').forEach(cb => {
                    cb.checked = favs.indexOf(cb.value) !== -1;
                });
            } catch (e) {
                console.error('Failed to load preferences', e);
            }
        }

        function savePreferences() {
            try {
                const prefs = {
                    favorites: Array.from(document.querySelectorAll('.fav-space:checked')).map(cb => cb.value),
                    contribute: !!document.querySelectorAll('.switch input[type="checkbox"]')[0].checked,
                    history: !!document.querySelectorAll('.switch input[type="checkbox"]')[1].checked,
                    push: !!document.querySelectorAll('.switch input[type="checkbox"]')[2].checked
                };
                localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
                applyPreferences();
                // Persist to server if user is logged in
                const token = getAuthToken();
                if (token) {
                    fetch(`${API_BASE}/profile`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ preferences: prefs })
                    }).then(r => r.json()).then(d => { console.log('Saved prefs to server', d); alert('Preferences saved'); }).catch(e => { console.error('Failed to save prefs to server', e); alert('Preferences saved locally, failed to save to server'); });
                } else {
                    alert('Preferences saved');
                }
            } catch (e) {
                console.error('Failed to save preferences', e);
                alert('Failed to save preferences');
            }
        }

        function applyPreferences() {
            try {
                // currently no immediate UI application required; keep function for future use
                const raw = localStorage.getItem(PREFS_KEY);
                const prefs = raw ? JSON.parse(raw) : defaultPreferences();
                // Favorites and toggles are stored; apply logic can be added here later
            } catch (e) {
                console.error('Failed to apply preferences', e);
            }
        }

        document.getElementById('savePrefsBtn').addEventListener('click', (e) => { e.preventDefault(); savePreferences(); });
        document.getElementById('cancelPrefsBtn').addEventListener('click', (e) => { e.preventDefault(); loadPreferences(); });

        // Change password handlers
        document.getElementById('savePasswordBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const token = getAuthToken();
            if (!token) { alert('You must be logged in'); return; }
            const current = document.getElementById('currentPassword').value;
            const next = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;
            if (next.length < 8) { alert('New password must be at least 8 characters'); return; }
            if (next !== confirm) { alert('New password and confirmation do not match'); return; }
            try {
                const res = await fetch(`${API_BASE}/profile/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ current_password: current, new_password: next, new_password_confirmation: confirm })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(data.message || 'Password changed successfully');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    alert(data.message || 'Failed to change password');
                }
            } catch (err) {
                console.error('Error changing password', err);
                alert('Server error');
            }
        });

        document.getElementById('cancelPasswordBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        });
    </script>
</body>
</html>
