<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Campus IMS</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            display: flex;
            min-height: 100vh;
            background-color: #f0f4f8;
        }

        .admin-sidebar {
            width: 250px;
            background: white;
            padding: 2rem 1.5rem;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.08);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .admin-sidebar h2 {
            font-size: 1.25rem;
            color: var(--dark);
            margin-bottom: 2rem;
        }

        .admin-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .admin-nav-item:hover,
        .admin-nav-item.active {
            background-color: #f0f4f8;
            color: var(--primary);
        }

        .admin-nav-item i {
            width: 20px;
        }

        .admin-main {
            margin-left: 250px;
            flex: 1;
            padding: 2rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .admin-header h1 {
            font-size: 2rem;
            color: var(--dark);
            margin: 0;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0 0 0.5rem 0;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            color: var(--primary);
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .admin-table-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .admin-table-container h3 {
            margin: 0 0 1rem 0;
            color: var(--dark);
            font-size: 1.25rem;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table thead {
            background-color: #f0f4f8;
        }

        .admin-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #e2e8f0;
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .admin-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-edit {
            background-color: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background-color: #2563eb;
        }

        .btn-delete {
            background-color: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background-color: #dc2626;
        }

        .btn-add {
            background-color: #22c55e;
            color: white;
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .btn-add:hover {
            background-color: #16a34a;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            color: var(--dark);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .activity-log-item {
            padding: 1rem;
            border-left: 4px solid var(--primary);
            background-color: #f0f4f8;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .activity-log-item .timestamp {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .activity-log-item .user-name {
            font-weight: 600;
            color: var(--dark);
        }

        .activity-log-item .description {
            margin-top: 0.5rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                width: 100%;
                height: auto;
                position: relative;
                margin-bottom: 1rem;
            }

            .admin-main {
                margin-left: 0;
            }

            .admin-nav {
                flex-direction: row;
                gap: 0.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <script>
        // Define functions early so onclick handlers can find them
        // ensure base API url is correct for admin routes; app.js may have pointed to /api/spaces
        if (typeof API_URL === 'undefined' || API_URL.endsWith('/spaces')) {
            API_URL = 'http://127.0.0.1:8000/api';
        }
        const AUTH_TOKEN = localStorage.getItem('auth_token');

        window.switchSection = function(section, button) {
            // show selected section and update nav active state
            document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
            if (button) button.classList.add('active');
            // update page title and hash
            const titles = { 'dashboard': 'Dashboard', 'spaces': 'Manage Spaces', 'users': 'Manage Users', 'pending': 'Pending Verifications', 'activity': 'Activity Logs' };
            document.getElementById('sectionTitle').textContent = titles[section] || '';
            window.location.hash = section;
            // load data if needed
            if (section === 'dashboard') window.loadDashboard();
            if (section === 'spaces') window.loadSpaces();
            if (section === 'users') window.loadUsers();
            if (section === 'pending') window.loadPending();
            if (section === 'activity') window.loadActivityLogs();
        };

        window.openAddSpaceModal = function() {
            document.getElementById('spaceModalTitle').textContent = 'Add New Space';
            document.getElementById('spaceForm').reset();
            document.getElementById('spaceModal').classList.add('active');
        };

        window.closeSpaceModal = function() {
            document.getElementById('spaceModal').classList.remove('active');
        };

        window.deleteSpace = async function(id) {
            if (!confirm('Are you sure you want to delete this space?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/spaces/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (res.ok) {
                    alert('Space deleted successfully!');
                    window.loadSpaces();
                } else {
                    alert('Failed to delete space');
                }
            } catch (error) {
                console.error('Error deleting space:', error);
            }
        };

        window.deleteUser = async function(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (res.ok) {
                    alert('User deleted successfully!');
                    window.loadUsers();
                } else {
                    alert('Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        };

        window.logout = function() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_name');
            window.location.href = 'index.html';
        };
    </script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <h2><i class="fas fa-cog"></i> Admin Panel</h2>
            <nav class="admin-nav">
                <button class="admin-nav-item active" onclick="switchSection('dashboard', this)">
                    <i class="fas fa-chart-line"></i> Dashboard
                </button>
                <button class="admin-nav-item" onclick="switchSection('spaces', this)">
                    <i class="fas fa-building"></i> Spaces
                </button>
                <button class="admin-nav-item" onclick="switchSection('users', this)">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="admin-nav-item" onclick="switchSection('pending', this)">
                    <i class="fas fa-hourglass-half"></i> Pending Verifications
                </button>
                <button class="admin-nav-item" onclick="switchSection('activity', this)">
                    <i class="fas fa-history"></i> Activity Logs
                </button>
                <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 1rem 0;">
                <button class="admin-nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <div>
                    <h1 id="sectionTitle">Dashboard</h1>
                    <p class="header-subtitle">Manage your campus spaces and users</p>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="admin-section active">
                <div class="stats-grid" id="statsGrid">
                    <!-- Populated by JS -->
                </div>

                <div class="admin-table-container">
                    <h3>Quick View: All Spaces</h3>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Space Name</th>
                                <th>Occupancy</th>
                                <th>Occupancy %</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardSpacesBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pending Verifications Section -->
            <div id="pending" class="admin-section" style="display:none;">
                <div class="admin-table-container">
                    <h3>Pending Student Verifications</h3>
                    <table class="admin-table" id="pendingTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Student ID</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- to be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Spaces Section -->
            <div id="spaces" class="admin-section">
                <button class="btn-add" onclick="openAddSpaceModal()">
                    <i class="fas fa-plus"></i> Add New Space
                </button>

                <div class="admin-table-container">
                    <h3>All Spaces</h3>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Space Name</th>
                                <th>Occupancy</th>
                                <th>Occupancy %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="spacesTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="admin-section">
                <div class="admin-table-container">
                    <h3>All Users</h3>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Student ID</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Activity Logs Section -->
            <div id="activity" class="admin-section">
                <div class="admin-table-container">
                    <h3>Recent Activity</h3>
                    <div id="activityLogsList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Space Modal -->
    <div id="spaceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="spaceModalTitle">Add New Space</span>
                <button class="modal-close" onclick="closeSpaceModal()">&times;</button>
            </div>
            <form class="modal-form" id="spaceForm">
                <div class="form-group">
                    <label>Space Name</label>
                    <input type="text" id="spaceName" required>
                </div>
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" id="spaceCapacity" min="1" required>
                </div>
                <!-- occupancy and status are managed automatically; admin provides only name and capacity -->
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeSpaceModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Space</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Load functions implementation
        window.loadDashboard = async function() {
            try {
                const statsRes = await fetch(`${API_URL}/admin/dashboard-stats`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!statsRes.ok) {
                    console.error('Stats response not ok:', statsRes.status);
                    return;
                }
                
                const stats = await statsRes.json();
                console.log('Stats:', stats);

                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>Total Spaces</h3>
                        <div class="stat-value">${stats.total_spaces}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="stat-value">${stats.total_users}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Capacity</h3>
                        <div class="stat-value">${stats.total_capacity}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Current Occupancy</h3>
                        <div class="stat-value">${stats.total_occupancy}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Occupancy Rate</h3>
                        <div class="stat-value">${stats.avg_occupancy_rate}%</div>
                    </div>
                `;

                // Load quick space view using same logic as fetchSpaces()
                let spacesUrl = API_URL;
                if (spacesUrl.endsWith('/api')) {
                    spacesUrl += '/spaces';
                } else {
                    // if it already pointed at /api/spaces leave it
                }
                const spacesRes = await fetch(spacesUrl);
                if (!spacesRes.ok) {
                    console.error('Spaces response not ok:', spacesRes.status, 'url=', spacesUrl);
                    return;
                }
                const spaces = await spacesRes.json();
                console.log('Spaces:', spaces);

                const spacesBody = document.getElementById('dashboardSpacesBody');
                if (spaces && spaces.length > 0) {
                    spacesBody.innerHTML = spaces.map(space => `
                        <tr>
                            <td>${space.name}</td>
                            <td>${space.occupancy} / ${space.capacity}</td>
                            <td>${space.occupancy_percentage}%</td>
                        </tr>
                    `).join('');
                } else {
                    spacesBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem;">No spaces found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // give more context if it's a network failure
                let msg = error.message || 'Unknown error';
                if (error.name === 'TypeError' && msg === 'Failed to fetch') {
                    msg = 'Network error when contacting API. Is the backend running?';
                }
                alert('Error loading dashboard: ' + msg);
            }
        }

        // Load Spaces
        window.loadSpaces = async function() {
            try {
                const res = await fetch(`${API_URL}/spaces`);
                
                if (!res.ok) {
                    console.error('Spaces response not ok:', res.status);
                    return;
                }
                
                const spaces = await res.json();
                console.log('Spaces loaded:', spaces);

                const tbody = document.getElementById('spacesTableBody');
                if (spaces && spaces.length > 0) {
                    tbody.innerHTML = spaces.map(space => `
                        <tr>
                            <td>${space.name}</td>
                            <td>${space.occupancy} / ${space.capacity}</td>
                            <td>${space.occupancy_percentage}%</td>
                            <td>
                                <button class="btn-sm btn-delete" onclick="deleteSpace(${space.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem;">No spaces found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading spaces:', error);
            }
        }

        // Load Users
        window.loadUsers = async function() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!res.ok) {
                    console.error('Users response not ok:', res.status);
                    return;
                }
                
                const users = await res.json();
                console.log('Users loaded:', users);

                const tbody = document.getElementById('usersTableBody');
                if (users && users.length > 0) {
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.student_id || ''}</td>
                            <td>${user.email}</td>
                            <td>${user.status}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn-sm btn-delete" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem;">No users found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load pending verifications
        window.loadPending = async function() {
            console.log('loadPending called, API_URL=', API_URL);
            try {
                const res = await fetch(`${API_URL}/admin/pending-users`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                console.log('pending-users response status', res.status);
                if (!res.ok) {
                    console.error('Pending response not ok', res.status);
                    return;
                }
                const students = await res.json();
                console.log('Pending students:', students);
                const tbody = document.querySelector('#pendingTable tbody');
                if (students && students.length > 0) {
                    tbody.innerHTML = students.map(u => `
                        <tr>
                            <td>${u.name}</td>
                            <td>${u.student_id || ''}</td>
                            <td>${u.email}</td>
                            <td>
                                <button class="btn-sm btn-edit" onclick="approveUser(${u.id})">Approve</button>
                                <button class="btn-sm btn-delete" onclick="rejectUser(${u.id})">Reject</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:1rem;">No pending requests</td></tr>';
                }
            } catch (err) {
                console.error('Error loading pending users:', err);
            }
        }

        window.approveUser = async function(id) {
            try {
                const res = await fetch(`${API_URL}/admin/users/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (res.ok) {
                    alert('User approved');
                    window.loadPending();
                } else {
                    alert('Failed to approve');
                }
            } catch (err) {
                console.error(err);
            }
        }

        window.rejectUser = async function(id) {
            try {
                const res = await fetch(`${API_URL}/admin/users/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (res.ok) {
                    alert('User rejected');
                    window.loadPending();
                } else {
                    alert('Failed to reject');
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Load Activity Logs
        window.loadActivityLogs = async function() {
            try {
                const res = await fetch(`${API_URL}/admin/activity-logs`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!res.ok) {
                    console.error('Activity logs response not ok:', res.status);
                    return;
                }
                
                const logs = await res.json();
                console.log('Activity logs loaded:', logs);

                const container = document.getElementById('activityLogsList');
                if (logs && logs.length > 0) {
                    container.innerHTML = logs.map(log => `
                        <div class="activity-log-item">
                            <div class="timestamp">${new Date(log.created_at).toLocaleString()}</div>
                            <div><span class="user-name">${log.user.name}</span> ${log.action} ${log.target_model}</div>
                            <div class="description">${log.description}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">No activity logs yet</div>';
                }
            } catch (error) {
                console.error('Error loading activity logs:', error);
            }
        }

        // Save Space
        document.getElementById('spaceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('spaceName').value;
            const capacity = parseInt(document.getElementById('spaceCapacity').value);

            try {
                const res = await fetch(`${API_URL}/admin/spaces`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ name, capacity })
                });

                if (res.ok) {
                    alert('Space created successfully!');
                    try {
                        const spacesChannel = new BroadcastChannel('campus_spaces');
                        spacesChannel.postMessage({ type: 'spaces_updated', timestamp: Date.now() });
                        spacesChannel.close();
                    } catch(err) {
                        console.warn('BroadcastChannel not available, using localStorage fallback');
                        try { localStorage.setItem('spaces_updated_at', Date.now().toString()); } catch(e){}
                    }
                    closeSpaceModal();
                    loadSpaces();
                } else {
                    alert('Failed to create space');
                }
            } catch (error) {
                console.error('Error creating space:', error);
            }
        });

        // Initial load - show section from hash if present
        window.addEventListener('load', () => {
            const hash = window.location.hash.replace('#','');
            const valid = ['dashboard','spaces','users','pending','activity'];
            if (hash && valid.includes(hash)) {
                const button = document.querySelector(`.admin-nav-item[onclick*="'${hash}'"]`);
                window.switchSection(hash, button);
            } else {
                window.switchSection('dashboard', document.querySelector('.admin-nav-item.active'));
            }
        });
    </script>
</body>
</html>